- name: "Build hosts file"
  lineinfile:
    dest: /etc/hosts
    regexp: '.*{{ item }}$'
    line: "{{ hostvars[item].ansible_host }} {{item}}"
    state: present
  when:
    - hostvars[item].ansible_host is defined
    # Etc hosts expect IP addresses
    - hostvars[item].ansible_host is ansible.utils.ipv4
    # The local hostname is expected to stay 127.0.1.1
    - item != ansible_hostname
    - not ansible_module_running_in_container
  with_items: "{{ groups.all }}"
