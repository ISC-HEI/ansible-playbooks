- name: Display admins
  run_once: true
  delegate_to: localhost
  debug:
    msg: "admins: {{ admin_uids | map(attribute='name') | join(', ') }}"

- name: create sudonopass groups
  ansible.builtin.group:
    system: true
    name: "sudonopass"

- name: admin group names
  set_fact:
    admin_group_names: "{{ admin_gids | map(attribute='name') + ['adm','plugdev','users','sudonopass'] }}"

- name: create admins
  ansible.builtin.user:
    name: "{{ item.name }}"
    uid: "{{ item.id }}"
    comment: "{{ item.email | default(omit) }}"
    shell: "{{ item.shell }}"
    update_password: on_create
  with_items:
    - "{{ admin_uids }}"

- name: create admin groups
  ansible.builtin.group:
    name: "{{ item }}"
    state: present
  loop: "{{ admin_group_names }}"

- name: admin users groups
  ansible.builtin.user:
    name: "{{ item.name }}"
    groups: "{{ admin_group_names }}"
    append: true
  with_items:
    - "{{ admin_uids }}"

- name: sudo without password
  community.general.sudoers:
    name: admin-nopass
    group: sudonopass
    commands: ALL

- name: ubuntu user authorized_keys
  ansible.posix.authorized_key:
    manage_dir: true
    user: ubuntu
    key: "{{ lookup('file', conf_dir ~ '/authorized_keys/' ~ item.name ~ '.pub') }}"
  with_items:
    - "{{ admin_uids }}"

- name: admin users authorized_key
  ansible.posix.authorized_key:
    manage_dir: true
    user: "{{ item.name }}"
    key: "{{ lookup('file', conf_dir ~ '/authorized_keys/' ~ item.name ~ '.pub') }}"
  with_items:
    - "{{ admin_uids }}"
